<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ»´æ°´æ°´ç¼¸ Demo</title>
  <style>
    body {
      background: #f0f2f5;
      font-family: "å¾®è½¯é›…é»‘", sans-serif;
      padding: 30px;
      text-align: center;
    }

    h1 {
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
    }

    .tank {
      position: relative;
      width: 120px;
      height: 200px;
      border: 4px solid #888;
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
      margin: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .tank:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .water {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to top, #4fc3f7 0%, #81d4fa 100%);
      transition: height 0.3s ease;
    }

    .drop {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #4fc3f7;
      animation: drop 1s infinite;
      z-index: 10;
    }

    .controls {
      margin: 20px auto;
      text-align: center;
    }

    #createTankBtn {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    #createTankBtn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .sell-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 3px 6px;
      font-size: 12px;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .sell-btn:disabled {
      background-color: #ffaaaa;
      cursor: not-allowed;
    }

    .tank-quality {
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 10; /* ç¡®ä¿å“è´¨æ ‡ç­¾æ˜¾ç¤ºåœ¨æ°´é¢ä¹‹ä¸Š */
      padding: 2px 4px;
      border-radius: 3px;
      background-color: rgba(0,0,0,0.5);
    }

    /* å“è´¨æ ·å¼ä¸å‘å…‰æ•ˆæœ */
    .tank.black-iron { border-color: #555555; box-shadow: 0 0 5px #555555; }
    .tank.bronze { border-color: #cd7f32; box-shadow: 0 0 8px #cd7f32; }
    .tank.silver { border-color: #c0c0c0; box-shadow: 0 0 8px #c0c0c0; }
    .tank.gold { border-color: #ffd700; box-shadow: 0 0 10px #ffd700; }
    .tank.platinum { border-color: #e5e4e2; box-shadow: 0 0 10px #e5e4e2; }
    .tank.emerald { border-color: #50c878; box-shadow: 0 0 12px #50c878; }
    .tank.diamond { border-color: #b9f2ff; box-shadow: 0 0 12px #b9f2ff; }
    .tank.master { border-color: #9966cc; box-shadow: 0 0 15px #9966cc; }
    .tank.grandmaster { border-color: #ff4500; box-shadow: 0 0 15px #ff4500; }
    .tank.challenger { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; }
    {background-color: #4fc3f7;
      animation: drop 1s infinite;
      z-index: 10;
    }

    @keyframes drop {
      0% { top: -20px; opacity: 1; }
      80% { top: 220px; opacity: 0.5; }
      100% { top: 220px; opacity: 0; }
    }
  </style>
</head>
<body>
  <h1>ğŸ’§ æ»´æ°´è£…æ°´ç¼¸ Demo</h1>
  <div class="controls">
    <button id="createTankBtn">ç”Ÿæˆæ°´ç¼¸</button>
    <div>æ€»èµ„äº§: <span id="money">0</span> é‡‘å¸</div>
  </div>
  <div class="container" id="container"></div>

  <script>
    const container = document.getElementById('container');
    const createBtn = document.getElementById('createTankBtn');
    const moneyDisplay = document.getElementById('money');
    let currentTanks = 0;
    const maxTanks = 5;
    let canCreate = true;
    let money = localStorage.getItem('tankGameMoney') || 0;
    moneyDisplay.textContent = money;
    let tankIntervals = []; // ç”¨äºå­˜å‚¨æ‰€æœ‰æ°´ç¼¸çš„å®šæ—¶å™¨

    // æ·»åŠ æ°´ç¼¸çŠ¶æ€æ£€æŸ¥å‡½æ•°
    function checkCreateButtonStatus() {
      // å¦‚æœå·²æœ‰5ä¸ªæ°´ç¼¸ï¼Œç¦ç”¨åˆ›å»ºæŒ‰é’®
      if (currentTanks >= maxTanks) {
        canCreate = false;
        createBtn.disabled = true;
        return;
      }

      // å¦‚æœæ²¡æœ‰æ°´ç¼¸ï¼Œå…è®¸åˆ›å»º
      if (currentTanks === 0) {
        canCreate = true;
        createBtn.disabled = false;
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ°´ç¼¸éƒ½å·²æ»¡
      const tanks = Array.from(container.children);
      const allFull = tanks.every(tank => {
        const water = tank.querySelector('.water');
        const percent = parseFloat(water.style.height) || 0;
        return percent >= 100;
      });

      // åªæœ‰æ‰€æœ‰æ°´ç¼¸éƒ½æ»¡äº†æ‰å…è®¸åˆ›å»ºæ–°çš„
      canCreate = allFull;
      createBtn.disabled = !allFull;
    }

    // æ°´ç¼¸å“è´¨é…ç½®ï¼šåç§°ã€å®¹é‡(æ»´)ã€ä»·æ ¼(é‡‘å¸)ã€æ¦‚ç‡ã€æ ·å¼ç±»
    const tankQualities = [
      { name: 'é»‘é“', capacity: 60, price: 1, probability: 0.50, className: 'black-iron' },
      { name: 'é’é“œ', capacity: 120, price: 5, probability: 0.20, className: 'bronze' },
      { name: 'ç™½é“¶', capacity: 200, price: 10, probability: 0.10, className: 'silver' },
      { name: 'é»„é‡‘', capacity: 320, price: 15, probability: 0.08, className: 'gold' },
      { name: 'é“‚é‡‘', capacity: 480, price: 20, probability: 0.06, className: 'platinum' },
      { name: 'ç¿¡ç¿ ', capacity: 640, price: 50, probability: 0.02, className: 'emerald' },
      { name: 'é’»çŸ³', capacity: 810, price: 100, probability: 0.018, className: 'diamond' },
      { name: 'å¤§å¸ˆ', capacity: 1000, price: 500, probability: 0.012, className: 'master' },
      { name: 'å®—å¸ˆ', capacity: 1400, price: 1000, probability: 0.007, className: 'grandmaster' },
      { name: 'ç‹è€…', capacity: 1800, price: 1000000, probability: 0.003, className: 'challenger' }
    ];

    // ä¿å­˜æ‰€æœ‰æ°´ç¼¸çŠ¶æ€åˆ°localStorage
    function saveTanksToLocalStorage() {
      const tanksData = Array.from(container.children).map((tank) => {
        const qualityClass = tank.className.split(' ')[1];
        const quality = tankQualities.find(q => q.className === qualityClass);
        const water = tank.querySelector('.water');
        const percent = parseFloat(water.style.height);
        const drops = Math.round((percent / 100) * quality.capacity);

        return {
          qualityIndex: tankQualities.indexOf(quality),
          drops: drops,
          lastUpdateTime: Date.now() // ä¿å­˜æœ€åæ›´æ–°æ—¶é—´è€Œéå¼€å§‹æ—¶é—´
        };
      });
      localStorage.setItem('tankGameTanks', JSON.stringify(tanksData));
    }

    // ä»localStorageåŠ è½½æ°´ç¼¸çŠ¶æ€
    function loadTanksFromLocalStorage() {
      const savedTanks = localStorage.getItem('tankGameTanks');
      if (!savedTanks) return [];

      try {
        return JSON.parse(savedTanks);
      } catch (e) {
        console.error('Failed to parse saved tanks:', e);
        localStorage.removeItem('tankGameTanks'); // ç§»é™¤æŸåçš„æ•°æ®
        return [];
      }
    }

    // æ ¹æ®æ¦‚ç‡éšæœºé€‰æ‹©æ°´ç¼¸å“è´¨
    function getRandomQuality() {
      const random = Math.random();
      let cumulativeProbability = 0;
      for (const quality of tankQualities) {
        cumulativeProbability += quality.probability;
        if (random < cumulativeProbability) {
          return quality;
        }
      }
      return tankQualities[0]; // é»˜è®¤è¿”å›æœ€ä½å“è´¨
    }

    // åˆ›å»ºæ°´ç¼¸ - æ–°å¢å‚æ•°: isLoadMode(åŠ è½½æ¨¡å¼)
    function createTank(initialDrops = 0, quality = null, isLoadMode = false) {
      if (currentTanks >= maxTanks && !isLoadMode) return; // åŠ è½½æ¨¡å¼ä¸å—åˆ›å»ºé™åˆ¶

      // åªæœ‰ç”¨æˆ·ä¸»åŠ¨åˆ›å»ºæ—¶æ‰æ¶ˆè€—åˆ›å»ºæœºä¼š
      if (!isLoadMode) {
        canCreate = false;
        createBtn.disabled = true;
      }
      currentTanks++;

      // è·å–å“è´¨ - å¦‚æœæœªæŒ‡å®šåˆ™éšæœº
      const tankQuality = quality || getRandomQuality();

      // åˆ›å»ºæ°´ç¼¸å…ƒç´ 
      const tank = document.createElement('div');
      tank.className = `tank ${tankQuality.className}`;

      // å“è´¨æ ‡ç­¾
      const qualityLabel = document.createElement('div');
      qualityLabel.className = 'tank-quality';
      qualityLabel.textContent = tankQuality.name;

      // æ°´å…ƒç´ 
      const water = document.createElement('div');
      water.className = 'water';
      const initialPercent = initialDrops > 0 ? Math.min((initialDrops / tankQuality.capacity) * 100, 100) : 0;
      water.style.height = initialPercent + '%';

      const drop = document.createElement('div');
      drop.className = 'drop';

      const sellBtn = document.createElement('button');
      sellBtn.className = 'sell-btn';
      sellBtn.textContent = 'å‡ºå”®';
      sellBtn.disabled = initialPercent < 100;

      // ç»„è£…æ°´ç¼¸
      tank.appendChild(qualityLabel);
      tank.appendChild(water);
      tank.appendChild(drop);
      tank.appendChild(sellBtn);
      container.appendChild(tank);

      // è£…æ°´é€»è¾‘
      let drops = initialDrops;
      let lastUpdateTime = Date.now();
      let requestId;
      
      // åˆå§‹çŠ¶æ€æ£€æŸ¥ - å¦‚æœå·²ç»æ»¡äº†ï¼Œç›´æ¥éšè—æ°´æ»´
      if (initialDrops >= tankQuality.capacity) {
        drop.style.display = 'none';
      }
      
      function updateDrops() {
        const now = Date.now();
        const elapsedSeconds = Math.floor((now - lastUpdateTime) / 1000);
        
        if (elapsedSeconds > 0) {
          drops += elapsedSeconds;
          lastUpdateTime = now;
          
          const percent = Math.min((drops / tankQuality.capacity) * 100, 100);
          water.style.height = percent + '%';
          tank.dataset.lastUpdateTime = now.toString();
          
          // å®šæœŸä¿å­˜çŠ¶æ€
          if (drops % 5 === 0) {
            saveTanksToLocalStorage();
          }
          
          // è£…æ»¡æ°´æ—¶å¯ç”¨å‡ºå”®æŒ‰é’®
          if (drops >= tankQuality.capacity) {
            // å…³é”®ä¿®å¤ï¼šä½¿ç”¨cancelAnimationFrameä»£æ›¿clearInterval
            cancelAnimationFrame(requestId);
            sellBtn.disabled = false;
            // éšè—æ°´æ»´å…ƒç´ 
            drop.style.display = 'none';
            saveTanksToLocalStorage();
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ›å»ºæ–°æ°´ç¼¸
            checkCreateButtonStatus();
            return; // ç¡®ä¿ä¸å†ç»§ç»­æ‰§è¡Œ
          }
        }
        
        requestId = requestAnimationFrame(updateDrops);
      }
      
      requestId = requestAnimationFrame(updateDrops);
      
      // ä¿å­˜åŠ¨ç”»å¸§IDä»¥ä¾¿æ¸…ç†
      tankIntervals.push(requestId);

      // å‡ºå”®åŠŸèƒ½
      sellBtn.addEventListener('click', () => {
        // æ›´æ–°é‡‘é’±
        money = parseInt(money) + tankQuality.price;
        moneyDisplay.textContent = money;
        localStorage.setItem('tankGameMoney', money);

        // ä»DOMä¸­ç§»é™¤æ°´ç¼¸
        container.removeChild(tank);
        currentTanks--;

        // æ¸…é™¤å®šæ—¶å™¨
        const intervalIndex = tankIntervals.indexOf(interval);
        if (intervalIndex !== -1) {
          clearInterval(tankIntervals[intervalIndex]);
          tankIntervals.splice(intervalIndex, 1);
        }

        // å…è®¸åˆ›å»ºæ–°æ°´ç¼¸
        checkCreateButtonStatus();

        // ä¿å­˜çŠ¶æ€
        saveTanksToLocalStorage();
      });

      // åˆå§‹ä¿å­˜
      saveTanksToLocalStorage();
      return tank;
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤æ°´ç¼¸
    window.addEventListener('load', () => {
      const savedTanks = loadTanksFromLocalStorage();
      if (savedTanks.length > 0) {
        // æ¢å¤ä¿å­˜çš„æ°´ç¼¸
        savedTanks.forEach(tankData => {
          const quality = tankQualities[tankData.qualityIndex];
          if (!quality) return; // æ— æ•ˆå“è´¨æ•°æ®è·³è¿‡

          // è®¡ç®—ä»ä¸Šæ¬¡æ›´æ–°åˆ°ç°åœ¨åº”è¯¥å¢åŠ çš„æ°´æ»´æ•°
          const elapsedSeconds = Math.floor((Date.now() - tankData.lastUpdateTime) / 1000);
          let currentDrops = tankData.drops + elapsedSeconds;

          // ç¡®ä¿æ°´æ»´æ•°ä¸è¶…è¿‡æ°´ç¼¸å®¹é‡
          currentDrops = Math.min(currentDrops, quality.capacity);

          // ä½¿ç”¨åŠ è½½æ¨¡å¼åˆ›å»ºæ°´ç¼¸
          createTank(currentDrops, quality, true);
        });

        // æ¢å¤å®Œæˆåæ£€æŸ¥åˆ›å»ºæŒ‰é’®çŠ¶æ€
        setTimeout(() => {
          checkCreateButtonStatus();
        }, 100);
      } else {
        // åˆå§‹çŠ¶æ€ï¼šå¦‚æœæ²¡æœ‰æ°´ç¼¸ï¼Œå…è®¸ç«‹å³åˆ›å»º
        checkCreateButtonStatus();
      }
    });

    // é¡µé¢å…³é—­å‰ä¿å­˜çŠ¶æ€
    window.addEventListener('beforeunload', () => {
      saveTanksToLocalStorage();
      // æ¸…é™¤æ‰€æœ‰åŠ¨ç”»å¸§
      tankIntervals.forEach(id => cancelAnimationFrame(id));
    });
    
    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        // é¡µé¢å˜ä¸ºå¯è§æ—¶æ›´æ–°æ‰€æœ‰æ°´ç¼¸
        const now = Date.now();
        Array.from(container.children).forEach(tank => {
          const qualityClass = tank.className.split(' ')[1];
          const quality = tankQualities.find(q => q.className === qualityClass);
          const water = tank.querySelector('.water');
          const sellBtn = tank.querySelector('.sell-btn');
          
          if (sellBtn.disabled) {
            const lastUpdate = parseInt(tank.dataset.lastUpdateTime || Date.now());
            const elapsedSeconds = Math.floor((now - lastUpdate) / 1000);
            
            if (elapsedSeconds > 0) {
              let currentDrops = Math.round((parseFloat(water.style.height) / 100) * quality.capacity);
              currentDrops += elapsedSeconds;
              
              const percent = Math.min((currentDrops / quality.capacity) * 100, 100);
              water.style.height = percent + '%';
              tank.dataset.lastUpdateTime = now.toString();
              
              if (currentDrops >= quality.capacity) {
                sellBtn.disabled = false;
                checkCreateButtonStatus();
              }
            }
          }
        });
        saveTanksToLocalStorage();
      }
    });

    // åˆ›å»ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    createBtn.addEventListener('click', () => createTank());

    // æ•°æ®åº“ä¿å­˜å‡½æ•°(éœ€è¦åç«¯æ”¯æŒ)
    function saveToDatabase(money) {
      // å®é™…é¡¹ç›®ä¸­éœ€è¦å®ç°æ­¤å‡½æ•°
      // fetch('/api/save-money', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify({ money: money })
      // });
    }
  </script>
</body>
</html>
